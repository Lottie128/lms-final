generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  TEACHER
  STUDENT
  MODERATOR
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  role      UserRole @default(STUDENT)
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  taughtCourses Course[]     @relation("TeacherCourses")
  enrollments   Enrollment[]
  progress      Progress[]
  submissions   Submission[]

  @@map("users")
}

model Course {
  id          String   @id @default(uuid())
  title       String
  description String   @db.Text
  category    String
  thumbnail   String?
  isPublished Boolean  @default(false)
  teacherId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  teacher     User         @relation("TeacherCourses", fields: [teacherId], references: [id], onDelete: Cascade)
  lessons     Lesson[]
  enrollments Enrollment[]

  @@index([teacherId])
  @@index([category])
  @@index([isPublished])
  @@map("courses")
}

model Lesson {
  id          String   @id @default(uuid())
  courseId    String
  title       String
  description String?  @db.Text
  content     String   @db.Text
  videoUrl    String?
  order       Int
  duration    Int?     // in seconds
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  course      Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  assignments Assignment[]
  progress    Progress[]

  @@index([courseId])
  @@index([order])
  @@map("lessons")
}

model Assignment {
  id          String    @id @default(uuid())
  lessonId    String
  title       String
  description String    @db.Text
  dueDate     DateTime?
  maxPoints   Int       @default(100)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  lesson      Lesson       @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  submissions Submission[]

  @@index([lessonId])
  @@map("assignments")
}

model Submission {
  id           String    @id @default(uuid())
  assignmentId String
  studentId    String
  content      String    @db.Text
  fileUrls     String[]  @default([])
  grade        Int?
  feedback     String?   @db.Text
  submittedAt  DateTime  @default(now())
  gradedAt     DateTime?

  // Relations
  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student    User       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([assignmentId, studentId])
  @@index([studentId])
  @@map("submissions")
}

model Enrollment {
  id          String    @id @default(uuid())
  studentId   String
  courseId    String
  enrolledAt  DateTime  @default(now())
  completedAt DateTime?
  progress    Int       @default(0) // 0-100

  // Relations
  student User   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course  Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId])
  @@index([studentId])
  @@index([courseId])
  @@map("enrollments")
}

model Progress {
  id             String   @id @default(uuid())
  studentId      String
  lessonId       String
  completed      Boolean  @default(false)
  timeSpent      Int      @default(0) // in seconds
  lastAccessedAt DateTime @default(now())

  // Relations
  student User   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  lesson  Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([studentId, lessonId])
  @@index([studentId])
  @@index([lessonId])
  @@map("progress")
}
